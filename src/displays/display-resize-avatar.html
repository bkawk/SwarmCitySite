<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="display-resize-avatar">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
                max-width: 100vw;
                height: 100%;
            }

            .container {
                width: 100%;
                @apply --layout-vertical;
                @apply --layout-center-center;
            }

            .container[wide-layout] {
                width: 100%;
                @apply --layout-vertical;
                @apply --layout-start;
                @apply --layout-start-justified;
            }

            .container .top {
                width: 100%;
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-start-justified;
                height: 370px;
                margin-bottom: 5vh;
            }

            .container[wide-layout] .top {
                width: 100%;
                @apply --layout-vertical;
                @apply --layout-start;
                @apply --layout-start-justified;
                margin-bottom: 7vh;
            }

            .container .rotate-icon {
                position: relative;
                top: -54px;
                left: 98px;
                margin-bottom: -54px;
                @apply --rotate-blue-normal;
                cursor: pointer;
            }

            .container[wide-layout] .rotate-icon {
                position: relative;
                top: -54px;
                left: 198px;
                margin-bottom: -54px;
                @apply --rotate-blue-normal;
                cursor: pointer;
            }

            .file {
                display: none;
            }

            .bluetext {
                @apply --small-bold;
                cursor: pointer;
                color: var(--sc-blue);
                border-bottom: 2px dotted var(--sc-blue);
                margin: 50px 0px 0px 0px;
            }

            .blacktext {
                @apply --layout-horizontal;
                @apply --layout-center-justified;
                @apply --small-bold;
                color: var(--sc-grey4);
                margin: 10px 0px 0px 0px;
            }

            .container .confirmers {
                @apply --titlepage-confirmers;
            }

            .container[wide-layout] .confirmers {
                @apply --titlepage-confirmers-wide;
            }

            .container .confirmers>div:nth-child(1) {
                @apply --confirmers-x;
                @apply --xmark-grey4-normal;
            }

            .container .confirmers>div:nth-child(1):active {
                @apply --button-active;
            }

            .container .confirmers>div:nth-child(2) {
                @apply --icon-button-big;
            }

            .container .confirmers>div:nth-child(2):active {
                @apply --button-active;
            }

            .container .confirmers>div:nth-child(2)>div:nth-child(1) {
                @apply --vmark-blue-normal;
            }

            @media only screen and (-webkit-min-device-pixel-ratio: 1.5),
            only screen and (min--moz-device-pixel-ratio: 1.5),
            only screen and (min-resolution: 240dpi) {
                .close,
                .rotate-icon,
                .disagree,
                .agree {
                    @apply --retina;
                }
            }
        </style>
        <iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>
        <div class="container" wide-layout$="{{wide}}">
            <div class="top">

                <!-- <canvas id="canvas" class="canvas" on-mousemove="_panMove" on-mousedown="_panStart" on-mouseup="_panEnd" on-touchmove="_panMove"
                    on-touchstart="_panStart" on-touchend="_panEnd"></canvas> -->
                <div class="rotate-icon" on-click="_rotate"></div>
                <input type="file" name="file" id="file" class="file" on-change="_fileSelected" accept=".jpg, .jpeg, .png, .gif" />
                <canvas id="canvas" class="canvas" width="{{canvasWidth}}" height="{{canvasHeight}}">Your browser does not support HTML5 Canvas.</canvas>
                <paper-slider id="slider" step="0.01" value="0.5" min="0.0" max="1.0" on-immediate-value-change="_getScale"></paper-slider>{{scale}}
                <div class="blacktext">{{localize('scroll to zoom')}} - {{localize('drag to move')}}</div>

                <label for="file">
                    <p class="bluetext">{{localize('choose another file')}}</p>
                </label>
            </div>

            <div class="bottom">
                <div class="confirmers">
                    <div class="disagree" on-click="_back"></div>
                    <div class="round-button" on-click="_save">
                        <div class="agree"></div>
                    </div>
                </div>
            </div>

        </div>
    </template>
    <script>

        class DisplayResizeAvatar extends new ReduxMixin(Polymer.mixinBehaviors([
            Polymer.AppLocalizeBehavior,
        ],
            Polymer.Element
        )) {
            static get is() {
                return 'display-resize-avatar';
            }
            static get properties() {
                return {
                    /**
                    * Language is the users selected or determined language
                    * @type {String}
                    */
                    language: {
                        type: String,
                        statePath: 'language',
                    },
                    /**
                    * Path signlas to the parent to change the path
                    * @type {Boolean}
                    */
                    path: {
                        type: String,
                        reflectToAttribute: true,
                        notify: true,
                    },
                    /**
                    * Avatar represents the users IPFS to their avatar image
                    * @type {String}
                    */
                    avatar: {
                        type: String,
                        statePath: 'avatar',
                    },
                    /**
                    * routeEntry changes the exact moment pages change when routing
                    * @type {Array}
                    */
                    routeEntry: {
                        type: Array,
                        observer: '_reset',
                    },
                    /**
                    * routeEntry changes the exact moment pages change when routing
                    * @type {Array}
                    */
                    scale: {
                        type: Number,
                        value: 50,
                    },
                    /**
                    * The image
                    * @type {Array}
                    */
                    image: {
                        type: String,
                        observer: '_drawFile'
                    },
                                        /**
                    * The image
                    * @type {Array}
                    */
                    scale: {
                        type: Number,
                        value: 0.5,
                        observer: '_drawFile'
                    },
                    /**
                    * The image
                    * @type {Array}
                    */
                    angle: {
                        type: Number,
                        value: 0,
                        observer: '_drawFile'
                    },
                    /**
                    * The image
                    * @type {Array}
                    */
                    canvasWidth: {
                        type: Number,
                        value: 250,
                    },
                                        /**
                    * The image
                    * @type {Array}
                    */
                    canvasHeight: {
                        type: Number,
                        value: 250,
                    },
                };
            }
            /**
            * Redux action for setting avatar
            * @param {String} avatar
            */
            static get actions() {
                return Object.assign({
                    AVATAR: function(avatar) {
                        return {
                            type: 'AVATAR',
                            avatar: avatar,
                        };
                    },
                });
            }
            /**
            * Fired when the component is connected
            */
            connectedCallback() {
                super.connectedCallback();
                this.loadResources(this.resolveUrl('../text-translations.json'));
            }
            /**
            * Fired when the component is ready
            */
            ready() {
                super.ready();
                if (!this.$.canvas || !this.$.canvas.getContext) {
                    this.context = false;
                } else {
                    this.context = this.$.canvas.getContext("2d");
                    this.context.fillStyle = "#000";
                    this.context.fillRect(0, 0, 250, 250);
                    this.context.save();
                }
            }

            /**
            * Fired when the user selects a file
            * @param {event} event The event from the on-change
            */
            _fileSelected(event) {
                if (this.context && event.target.files && event.target.files[0]) {
                    var fileReader = new FileReader();
                    fileReader.onload = (e) => {
                        var img = new Image();
                        img.addEventListener("load", () => {
                            this.image = img;
                        });
                        img.src = e.target.result;
                    };       
                    fileReader.readAsDataURL(event.target.files[0]);
                }
            }

            _drawFile() {
                if(this.image && this.canvasWidth && this.canvasHeight && this.scale && this.context){
                    console.log('image: ' + this.image);
                    console.log('imageWidth: ' + this.image.width);
                    console.log('imageHeight: ' + this.image.height);
                    console.log('canvasWidth: ' + this.canvasWidth);
                    console.log('canvasHeight' + this.canvasHeight);
                    console.log('scale: ' + this.scale);
                    console.log('angle: ' + this.angle);
                    this.context.translate(this.canvasWidth*0.5, this.canvasHeight*0.5);
                    this.context.scale(this.scale, this.scale);
                    this.context.rotate(this.angle * Math.PI / 180);
                    this.context.drawImage(this.image, -this.image.width*0.5, -this.image.height*0.5);
                    
                }
            }

            _getScale(){
                this.scale = this.$.slider.immediateValue;
            }

            _rotate(){
                if (this.angle == 180) {
                    this.angle = 0;
                }
                this.angle = this.angle + 45;
            }

            /**
            * Fired when user selects the X back button, routs to previous page
            */
            _back() {
                window.history.back();
            }
            /**
            * Fired when the user selects save
            * @param {event} event The event from the on-change
            */
            _save() {
                const canvas = this.$.canvas;
                const jpegUrl = canvas.toDataURL('image/jpeg');
                // make a new canvas
                let newCanvas = document.createElement('canvas');
                newCanvas.width = 95;
                newCanvas.height = 95;
                let ctx = newCanvas.getContext('2d');
                let image = new Image();
                image.onload = () => {
                    ctx.drawImage(image, -77, -77);
                    const avatarUrl = newCanvas.toDataURL('image/jpeg');
                    let storage = JSON.parse(localStorage.getItem('SwarmCity'));
                    this.dispatch('AVATAR', avatarUrl);
                    storage.user.avatar = avatarUrl;
                    localStorage.setItem('SwarmCity', JSON.stringify(storage));
                    window.history.back();
                };
                image.src = jpegUrl;
            }

        } window.customElements.define(DisplayResizeAvatar.is, DisplayResizeAvatar);
    </script>
</dom-module>
